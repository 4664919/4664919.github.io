	<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.16-DEV" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> beanstalk使用介绍 &middot; simons blog </title>

  
  <link rel="stylesheet" href="http://blog.simonsun.net/css/poole.css">
  <link rel="stylesheet" href="http://blog.simonsun.net/css/syntax.css">
  <link rel="stylesheet" href="http://blog.simonsun.net/css/hyde.css">
  <link rel="stylesheet" href="http://blog.simonsun.net/css/fonts.googleapis.com.css">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="simons blog" />
  
  <script src="http://blog.simonsun.net/js/jquery.min.js"></script>
  <script src="http://blog.simonsun.net/js/highlight.min.js"></script>
  <link rel="stylesheet" href="http://blog.simonsun.net/js/highlight-github.min.css">
  
  <script>hljs.initHighlightingOnLoad();</script>
  <script type="text/javascript">
  $(document).ready(function() {
       
       
       
          });
</script>
</head>

	<body class="theme-base-08">
		<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://blog.simonsun.net/"><h1>simons blog</h1></a>
      <p class="lead">
       这里是Simon Sun的个人博客 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="/">Home</a> </li>
      
        <li><a href="/golang-beego-use/"> BeeGo初探 </a></li>
      
        <li><a href="/golang-code-source/"> Golang 源码初探 </a></li>
      
        <li><a href="/logv3/"> golang日志系统架构设计 </a></li>
      
        <li><a href="/welcome/"> 你好，Hugo </a></li>
      
        <li><a href="/s/"> 你好，Hugo2 </a></li>
      
        <li><a href="/golang-testing/"> 测试相关－golang </a></li>
      
        <li><a href="/arithmetic-binary-search/"> 算法 － 二分查找(Binary Search) </a></li>
      
        <li><a href="/golang-testing-code-coverage/"> 覆盖率测试－测试相关－golang </a></li>
      
    </ul>

    <p>&copy; 2016. All rights reserved. </p>
  </div>
</div>


		<div class="content container">
			<div class="post">
			 	<h1>beanstalk使用介绍</h1>
			  <span class="post-date">0001-01-01</span>
			      

<h3 id="使用beanstalk也有二年了-之前对项目的beanstalk进行封装-php版本-golang两个版本-这里纪录一个日志权当说明文档来用了-div:1b0a41cc7d2fc25b18368e05c17b19c8">使用beanstalk也有二年了，之前对项目的beanstalk进行封装(php版本、GoLang两个版本)，这里纪录一个日志权当说明文档来用了</div></h3>

<h4 id="beanstalk功能描述:1b0a41cc7d2fc25b18368e05c17b19c8">beanstalk功能描述：</h4>

<p>beanstalk是一个异步的队列服务，目标是把复杂、耗时的任务放到后端去执行。提升前端响应时间。确切的说这里说的前端、后端 就是beanstalk的producer-consumer，一个负责生产，一个负责消费</p>

<h4 id="使用中发现的优缺点:1b0a41cc7d2fc25b18368e05c17b19c8">使用中发现的优缺点：</h4>

<ul>
<li>对于小的队列应用场景，使用beanstalk可以很方便快速的使用</li>
<li>不支持分布式</li>

<li><p>数据只有一份</p>

<h4 id="使用中未解决的问题:1b0a41cc7d2fc25b18368e05c17b19c8">使用中未解决的问题：</h4></li>

<li><p>发现beanstalk在使用中，在量稍微大一些的时候，经常假死：“有任务，但是取不到任务” 这个问题在GoLang、PHP中均存在</p></li>
</ul>

<h4 id="业务实例:1b0a41cc7d2fc25b18368e05c17b19c8">业务实例：</h4>

<ul>
<li>比如发邮件、短信等。可以直接丢入队列，然后服务端去依次发送</li>
<li>比如电商中的业务、行为分析等操作</li>
</ul>

<h4 id="具体使用方式:1b0a41cc7d2fc25b18368e05c17b19c8">具体使用方式：</h4>

<p>一个任务的典型生命流程很简单：
<pre class="EnlighterJSRAW" data-enlighter-language="null">
put （丢任务，生产者）  reserve（取任务，消费者）        delete（删除）
-&gt; [READY]beanstalk的状态-&gt; [RESERVED]beanstalk的状态—&gt; 生命周期完成
</pre>
    producer中创建任务，put后producer生命周期就结束了
    <br>
    consumer负责干活。一般取出任务后删除即可。取出任务之前是ready状态。取出任务后就reserve状态。删除后任务就清掉了。</p>

<h4 id="完整的生命周期:1b0a41cc7d2fc25b18368e05c17b19c8">完整的生命周期:</h4>

<p><a href="/wp-content/uploads/2015/05/0DE6ACB1-70AB-412B-A3EB-AC8520B51D9A.png"><img src="http://dev.blog.simonsun.net/wp-content/uploads/2015/05/0DE6ACB1-70AB-412B-A3EB-AC8520B51D9A.png" alt="0DE6ACB1-70AB-412B-A3EB-AC8520B51D9A" /></a>
{{ % img src=&ldquo;/upload/beanstalk_life.png&rdquo; alt=&ldquo;beanstalk完整的生命周期&rdquo; %}}</p>

<p>Beanstalkd中完整的任务的生命周期。一个job有READY, RESERVED, DELAYED, BURIED四种状态。
<br>
当producer直接put一个job时，job就处于READY状态，等待consumer来处理，如果选择延迟 put，job就先到DELAYED状态，等待时间过后才迁移到READY状态。
<br>
<code>consumer</code>获取了当前READY的job后，该job的状态就迁移 到RESERVED，这样其他的consumer就不能再操作该job。
<br>
当consumer完成该job后，可以选择delete, release或者bury操作;
<br>
delete之后，job从系统消亡，之后不能再获取;
<br>
release操作可以重新把该job状态迁移回READY(也 可以延迟该状态迁移操作)，使其他的consumer可以继续获取和执行该job;
<br>
有意思的是bury操作，可以把该job休眠，等到需要的时候，再将休 眠的job kick回READY状态，也可以delete BURIED状态的job。
<br>
正是有这些有趣的操作和状态，才可以基于此做出很多意思的应用，比如要实现一个循环队列，就可以将RESERVED状态的 job休眠掉，等没有READY状态的job时再将BURIED状态的job一次性kick回READY状态。</p>

<h4 id="任务的状态:1b0a41cc7d2fc25b18368e05c17b19c8">任务的状态：</h4>

<ul>
<li>ready     等待状态，任务在等待consumer执行</li>
<li>reserved     任务准备状态，当任务从tube中取出来（包括准备取出来）时，这个任务就是reserved状态，其他consumer将取不到此任务</li>
<li>delayed      延时状态，任务在指定时间之后才会变为ready状态</li>
<li>buried       等待kick，通常是任务失败为此状态</li>
</ul>

<h4 id="参数说明:1b0a41cc7d2fc25b18368e05c17b19c8">参数说明：</h4>

<ul>
<li>pri &#8211; priority(优先级) － 支持0到2**32的优先级，值越小，优先级越高，默认优先级为1024。</li>
<li>ttr &#8211; time to run(任务执行时间) － 允许consumer执行这个任务的时间</li>
<li>delay － 定时执行的时间，秒为单位</li>
</ul>

<h4 id="命令列表:1b0a41cc7d2fc25b18368e05c17b19c8">命令列表：</h4>

<p>生产者使用命令
<br></p>

<p>put
写入一个任务
     $ put <pri> <delay> <ttr> <bytes>\r\n
<data>\r\n</p>

<h4 id="other-commands:1b0a41cc7d2fc25b18368e05c17b19c8">－－Other Commands－－</h4>

<ul>
<li>peek</li>
<li>kick</li>
<li>kick-job</li>
<li>stats-job</li>
<li>stats-tube</li>
<li>stats</li>
<li>list-tubes</li>
<li>list-tube-used</li>
<li>list-tubes-watched</li>
<li>quit</li>
</ul>

			</div>

			
		</div>

  </body>
</html>
