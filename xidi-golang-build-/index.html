	<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.16-DEV" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>  &middot; simons blog </title>

  
  <link rel="stylesheet" href="http://blog.simonsun.net/css/poole.css">
  <link rel="stylesheet" href="http://blog.simonsun.net/css/syntax.css">
  <link rel="stylesheet" href="http://blog.simonsun.net/css/hyde.css">
  <link rel="stylesheet" href="http://blog.simonsun.net/css/fonts.googleapis.com.css">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="simons blog" />
  
  <script src="http://blog.simonsun.net/js/jquery.min.js"></script>
  <script src="http://blog.simonsun.net/js/highlight.min.js"></script>
  <link rel="stylesheet" href="http://blog.simonsun.net/js/highlight-github.min.css">
  
  <script>hljs.initHighlightingOnLoad();</script>
  <script type="text/javascript">
  $(document).ready(function() {
       
       
       
          });
</script>
</head>

	<body class="theme-base-08">
		<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://blog.simonsun.net/"><h1>simons blog</h1></a>
      <p class="lead">
       这里是Simon Sun的个人博客 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="/">Home</a> </li>
      
        <li><a href="/golang-beego-use/"> BeeGo初探 </a></li>
      
        <li><a href="/golang-code-source/"> Golang 源码初探 </a></li>
      
        <li><a href="/logv3/"> golang日志系统架构设计 </a></li>
      
        <li><a href="/welcome/"> 你好，Hugo </a></li>
      
        <li><a href="/s/"> 你好，Hugo2 </a></li>
      
        <li><a href="/golang-testing/"> 测试相关－golang </a></li>
      
        <li><a href="/arithmetic-binary-search/"> 算法 － 二分查找(Binary Search) </a></li>
      
        <li><a href="/golang-testing-code-coverage/"> 覆盖率测试－测试相关－golang </a></li>
      
    </ul>

    <p>&copy; 2016. All rights reserved. </p>
  </div>
</div>


		<div class="content container">
			<div class="post">
			 	<h1></h1>
			  <span class="post-date">0001-01-01</span>
			      

<p>#喜地golang服务编译规范</p>

<p>##前置条件
 - GOPATH:必须注册两个，一个为第三方lib库，另一个为喜地lib库
 - 每个服务有自己的lib库，统一在[服务/trunk/src/服务名称/包名称] 下
 - 服务格式固定-参见目录格式说明</p>

<h2 id="当前-自动化部署之前-上线流程">当前[自动化部署之前]上线流程</h2>

<ul>
<li>首先把当前服务所属目录注册到GOPATH中-参见注册gopath</li>
<li>开始编译</li>
<li>部署到服务器</li>
<li>停止服务器上在运行的服务</li>
<li>升级到最新部署的服务</li>
<li>启动服务器上的服务</li>
</ul>

<p>#附录一些结构和shell说明;</p>

<p>####注册gopath：
<pre>
#!/bin/bash
CURDIR=<code>pwd</code>
OLDGOPATH=&ldquo;$GOPATH&rdquo;
export OLDGOPATH=&ldquo;$GOPATH&rdquo;
echo &ldquo;Your GOPATH is:&rdquo;
GOPATH=&ldquo;$GOPATH:$CURDIR&rdquo;
export GOPATH
echo &ldquo;Now GOPATH is: $GOPATH&rdquo;
echo &lsquo;Finished&rsquo;
</pre></p>

<p>####目录格式说明:
<pre>
├──                                     －－服务根目录
└── trunk                               －－服务的分支
    ├── bin                             －－二进制文件目录
    │   └── {$NAME}                     －－最新版本二进制分发文件
    │   └── {$NAME}.v.1&hellip;.             －－历史版本二进制分发文件
    ├── data                            －－数据文件夹，生产环境下，根据不同服务配置此目录可能不与bin同级(比如会放到/var/log/xidibuy/下)
    │   ├── conf                        －－配置文件目录
    │   │   └── config.toml             －－配置名称
    │   │   └── config.xxxx             －－其它配置或历史配置
    │   ├── static                      －－静态文件目录，非必须存在
    │         &hellip;.                      －－其它目录，例如：view,log&hellip;.
    │         &hellip;.
    ├── pkg                             －－编译生成的pkg
    ├── src                             －－go代码源文件目录
    │   ├── {$NAME}                     －－服务名称
    │   │   ├── config                  －－当前服务所属的子包
    │   │   ├── controller              －－当前服务所属的子包
    │   │   ├── &hellip;<br />
    │   ├── main.go                     －－程序入口
    │   ├── README.md                   －－说明文件
    │   ├── &hellip;..
</pre></p>

<p>####编译:
<pre>
 #!/usr/bin/env bash
APP_NAME=&ldquo;code&rdquo;
echo &ldquo;begin build ${APP_NAME}:\n&rdquo;
go build -o ${APP_NAME}./src/${APP_NAME}/
echo &ldquo;strip ${APP_NAME}:\n&rdquo;
strip ${APP_NAME}
</pre></p>

<p>####部署到服务器:
<pre>
#!/usr/bin/env bash
echo &ldquo;begin sync to 10:\n&rdquo;
scp ${APP_NAME} zengbo@192.168.80.10:/var/www/backend/Go/${APP_NAME}/${APP_NAME}_tmp
if [ ${更新配置文件} -gt 0 ]
echo &ldquo;updata config.toml\n&rdquo;
scp ./data/conf/config.toml zengbo@192.168.80.10:/var/www/backend/Go/${APP_NAME}/config.toml_tmp
then
fi
echo &ldquo;ok\n&rdquo;
</pre></p>

<p>####停止正在运行的服务:
<pre>
#!/bin/bash</p>

<h1 id="停止服务shell">停止服务shell</h1>

<p>#
APP_NAME=&ldquo;code&rdquo;
DIR=<code>/var/www/backend/Go/{$APP_NAME}</code>
cd $DIR
zero=0
echo &ldquo;begin reboot $APP_NAME program&rdquo;
#备份文件
file_name=<code>date +%Y%m%d_%H%M%S</code>
cp &ldquo;${APP_NAME}_tmp&rdquo;  &ldquo;bak/${APP_NAME}<em>bak</em>$file_name&rdquo;</p>

<p>#关闭正在运行的kjt
echo &ldquo;kill kjt&rdquo;
#kill
is_run=<code>ps axu|grep &quot;${APP_NAME}/${APP_NAME}&quot;|grep -v &quot;grep&quot;|awk '{print $2}'</code>
echo <code>ps axu|grep &quot;${APP_NAME}/${APP_NAME}&quot;|grep -v &quot;grep&quot;</code>
echo &ldquo;&mdash;-$is_run&mdash;&rdquo;
if [ ${#is_run[@]} -gt 0 ]
then
   #sh kill.sh &amp;
   <code>ps axu|grep &quot;${APP_NAME}/${APP_NAME}&quot;|grep -v &quot;grep&quot;|awk '{print $2}'|xargs kill -USR2</code>
   a=true
   while($a)
   do
       b=<code>ps axu|grep &quot;${APP_NAME}/${APP_NAME}&quot;|grep -v &quot;grep&quot;|awk '{print $2}'</code>
       if [ ${#b[@]} -eq $zero ]
           then
           a=false
        echo &ldquo;程序未运行&rdquo;
           else
               echo &ldquo;程序还在运行:,sleep2&rdquo;
               #增加2秒延迟
               /bin/sleep 2
       fi
   done
fi
echo &ldquo;success\n&rdquo;
</pre></p>

<p>####升级到最新部署的服务:
<pre>
#!/bin/bash
#移动文件
echo &ldquo;move file&rdquo;
mv &ldquo;bin/${APP_NAME}&rdquo; &ldquo;bin/${APP_NAME}.v0.1.1&rdquo;
mv &ldquo;${APP_NAME}_tmp&rdquo;  &ldquo;bin/${APP_NAME}&rdquo;
if [ ${更新配置文件} -gt 0 ]
then
echo &ldquo;updata config.toml\n&rdquo;
mv &ldquo;data/config/config.tomk&rdquo; &ldquo;data/config/config.tomk.v0.1.1&rdquo;
mv &ldquo;config.toml&rdquo;  &ldquo;data/config/config.tomk&rdquo;
echo &ldquo;ok\n&rdquo;
fi
</pre></p>

<p>####启动服务器上的服务:
<pre>
#!/bin/bash
#启动程序
echo &ldquo;run program&rdquo;
/var/www/backend/Go/${APP_NAME}/${APP_NAME} -c=&ldquo;/var/www/backend/Go/${APP_NAME}/data/conf/config.toml&rdquo; -d=true
echo &ldquo;OK!&rdquo;
</pre></p>

			</div>

			
		</div>

  </body>
</html>
